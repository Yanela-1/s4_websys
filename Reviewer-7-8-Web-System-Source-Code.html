<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeIgniter 4 Final Reviewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar for the question map */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 relative">

    <div id="app" class="w-full max-w-2xl bg-white rounded-xl shadow-xl overflow-hidden relative z-10">
        
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white flex justify-between items-center shadow-md">
            <div>
                <h1 class="text-2xl font-bold">Web Systems (CI4)</h1>
                <p class="text-blue-100 text-sm mt-1">Final Randomized Reviewer</p>
            </div>
            <button onclick="toggleMap()" class="bg-blue-700 hover:bg-blue-800 text-white p-2 rounded-lg text-sm font-semibold transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                Map
            </button>
        </div>

        <!-- Content Area -->
        <div class="p-6 relative">
            
            <!-- Start Screen -->
            <div id="start-screen" class="text-center py-8">
                <div class="mb-6 text-gray-600">
                    <p class="mb-2">Total Questions: <span class="font-bold text-gray-900">49</span></p>
                    <p class="mb-4">Questions and choices are randomized every time.</p>
                    <ul class="text-sm text-left max-w-xs mx-auto space-y-2 bg-gray-50 p-4 rounded-lg border">
                        <li class="flex items-center gap-2">‚úÖ <span>Green = Correct Answer</span></li>
                        <li class="flex items-center gap-2">‚ùå <span>Red = Wrong Answer</span></li>
                        <li class="flex items-center gap-2">üîÄ <span>Jumbled Order</span></li>
                    </ul>
                </div>
                <button onclick="initQuiz()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition transform hover:scale-105 shadow-md">
                    Start Reviewer
                </button>
            </div>

            <!-- Quiz Interface -->
            <div id="quiz-screen" class="hidden fade-in">
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Question Header -->
                <div class="flex justify-between items-center mb-4">
                    <span id="question-counter" class="text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                        Question 1/49
                    </span>
                    <span id="current-score" class="text-sm text-gray-500 font-medium">Score: 0</span>
                </div>

                <!-- Question Text -->
                <h2 id="question-text" class="text-xl font-bold text-gray-800 mb-6 leading-relaxed min-h-[80px]"></h2>

                <!-- Options Container -->
                <div id="options-container" class="space-y-3 mb-6">
                    <!-- Options injected here by JS -->
                </div>

                <!-- Feedback Area -->
                <div id="feedback-area" class="mb-6 hidden p-4 rounded-lg border animate-pulse-once">
                    <p id="feedback-text" class="font-bold mb-1"></p>
                    <p id="correct-answer-text" class="text-sm text-gray-600"></p>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex gap-3 mt-4 pt-4 border-t border-gray-100">
                    <button id="prev-btn" onclick="prevQuestion()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Previous
                    </button>
                    <button id="next-btn" onclick="nextQuestion()" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-6 rounded-lg transition">
                        Next ‚Üí
                    </button>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden text-center py-8 fade-in">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Review Completed!</h2>
                <p class="text-gray-500 mb-6">Here is your performance:</p>
                
                <div class="inline-block bg-blue-50 rounded-full px-8 py-6 mb-8 border-2 border-blue-100">
                    <span id="final-score" class="text-5xl font-bold text-blue-600 block">0</span>
                    <span class="text-gray-500 text-sm uppercase tracking-wide">Total Score</span>
                </div>

                <div class="flex justify-center gap-4">
                    <button onclick="initQuiz()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-md">
                        Shuffle & Try Again
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Question Map Overlay -->
    <div id="map-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center backdrop-blur-sm" onclick="toggleMap()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 p-6 max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Question Map</h3>
                <button onclick="toggleMap()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="mb-4 flex gap-4 text-xs justify-center">
                <div class="flex items-center gap-1"><div class="w-3 h-3 bg-green-500 rounded-full"></div> Correct</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-500 rounded-full"></div> Incorrect</div>
                <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gray-200 rounded-full border"></div> Unanswered</div>
            </div>

            <div id="map-grid" class="grid grid-cols-5 gap-3 overflow-y-auto custom-scrollbar p-1">
                <!-- Grid items generated by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // NOTE: Updates applied for specific questions as requested.
        const rawQuestions = [
             {
                question: "What is the primary purpose of the Email class in CodeIgniter 4?",
                options: ["Sending emails", "Handling database queries", "Managing file uploads", "Sending HTTP requests"],
                correct: 0
            },
            {
                question: "Which method is used to load the Email class in CodeIgniter 4?",
                options: ["$email = \\Config\\Services::email();", "$this->email->load();", "$this->load->library('email')", "$email = new Email();"],
                correct: 0
            },
            {
                question: "Which method is used to set the recipient's email address?",
                options: ["$email->recipient('user@example.com');", "$email->setTo('user@example.com');", "$email->addRecipient('user@example.com');", "$email->setRecipient('user@example.com');"],
                correct: 1
            },
            {
                question: "Which method is used to set the email message body in CodeIgniter 4?",
                // Correct answer confirmed: $email->setMessage(...)
                options: ["$email->setContent('Message text');", "$email->setMessage('Message text');", "$email->setMessageBody('Message text');", "$email->body('Message text');"],
                correct: 1
            },
            {
                question: "How do you attach a file to an email in CodeIgniter 4?",
                options: ["$email->attachFile('path/to/file');", "$email->addAttachment('path/to/file');", "$email->setAttachment('path/to/file');", "$email->attach('path/to/file');"],
                correct: 3
            },
            {
                question: "What does the printDebugger() method do in the context of sending emails?",
                options: ["Prints the email body in the browser", "Saves the email to a log file", "Sends the email in debug mode", "Prints the debugging information of the email sending process"],
                correct: 3
            },
            {
                question: "Which configuration file is used to set global email settings in CodeIgniter 4?",
                options: ["app/Config/Mail.php", "app/Config/Database.php", "app/Config/Email.php", "app/Config/App.php"],
                correct: 2
            },
            {
                question: "Which method allows you to set a custom email header?",
                options: ["$email->addHeader('X-Custom-Header', 'value');", "$email->setCustomHeader('X-Custom-Header', 'value');", "$email->setHeader('X-Custom-Header', 'value');", "$email->customHeader('X-Custom-Header', 'value');"],
                correct: 2
            },
            {
                question: "How do you send an email to multiple recipients using CodeIgniter 4?",
                // Correct answer updated: The comma separated string format.
                options: ["$email->setTo('user1@example.com, user2@example.com');", "$email->setTo(['user1@example.com', 'user2@example.com']);", "$email->addRecipients(['user1@example.com', 'user2@example.com']);", "$email->setRecipients('user1@example.com, user2@example.com');"],
                correct: 0 
            },
            {
                question: "Which method is used to set the email priority in CodeIgniter 4?",
                options: ["$email->setPriority(1);", "$email->setImportance(1);", "$email->setMailPriority(1);", "$email->priority(1);"],
                correct: 0
            },
            {
                question: "What method is used to retrieve a file from a form submission in CodeIgniter 4?",
                options: ["$this->file->get('userfile');", "$this->input->file('userfile');", "$this->request->getFile('userfile');", "$this->upload->getFile('userfile');"],
                correct: 2
            },
            {
                question: "How can you get the MIME type of an uploaded file?",
                options: ["$file->getType();", "$file->getFileType();", "$file->getMimeType();", "$file->getMIME();"],
                correct: 2
            },
            {
                question: "What does the isValid() method return if the file is successfully uploaded?",
                options: ["An error message", "False", "Null", "True"],
                correct: 3
            },
            {
                question: "Which of the following methods will rename the uploaded file when moving it?",
                options: ["$file->move('path/to/directory', 'new_name.ext');", "$file->uploadAs('new_name.ext');", "$file->saveAs('new_name.ext');", "$file->rename('new_name.ext');"],
                correct: 0
            },
            {
                question: "How can you retrieve all uploaded files in a single request?",
                options: ["$this->request->getAllFiles();", "$this->request->getFiles();", "$this->request->files();", "$this->input->getFiles();"],
                correct: 1
            },
            {
                question: "Which of the following methods is used to crop an image?",
                options: ["trim()", "cut()", "crop()", "slice()"],
                correct: 2
            },
            {
                question: "How do you maintain the aspect ratio when resizing an image in CodeIgniter 4?",
                // Correct answer confirmed: "It maintains aspect ratio by default"
                options: ["maintainRatio()", "Set keepAspectRatio to true", "It maintains aspect ratio by default", "Use ratioResize()"],
                correct: 2
            },
            {
                question: "Which method is used to add a watermark to an image in CodeIgniter 4?",
                options: ["stamp()", "watermark()", "addWatermark()", "addMark()"],
                correct: 1
            },
            {
                question: "Which method is used to save the manipulated image to a file?",
                options: ["write()", "store()", "save()", "export()"],
                correct: 2
            },
            {
                question: "How can you flip an image horizontally in CodeIgniter 4?",
                options: ["flip('horizontal')", "flipX()", "flip('x')", "flipHorizontal()"],
                correct: 0
            },
            {
                question: "How do you set the sender's email address in CodeIgniter 4?",
                options: ["$email->fromAddress('your@example.com');", "$email->sender('your@example.com');", "$email->setSender('your@example.com');", "$email->setFrom('your@example.com');"],
                correct: 3
            },
            {
                question: "Which method is used to send an email in CodeIgniter 4?",
                options: ["$email->execute();", "$email->dispatch();", "$email->send();", "$email->deliver();"],
                correct: 2
            },
            {
                question: "What does setting the newline property do in the email configuration?",
                options: ["Determines how the email body is wrapped", "Specifies the newline character used in the email headers", "Defines the format of email content", "Adds line breaks in the email subject"],
                correct: 1
            },
            {
                question: "How do you set the subject of an email in CodeIgniter 4?",
                options: ["$email->subject('Subject');", "$email->setSubject('Subject');", "$email->setTitle('Subject');", "$email->addSubject('Subject');"],
                correct: 1
            },
            {
                question: "What is the default email protocol used by CodeIgniter 4?",
                // Correct answer confirmed: SMTP
                options: ["IMAP", "Mail", "SMTP", "Sendmail"],
                correct: 2
            },
            {
                question: "Which of the following is a valid mail type in CodeIgniter 4?",
                options: ["html", "text/html", "xhtml", "plain"],
                correct: 0
            },
            {
                question: "How do you set an email to be sent as plain text?",
                options: ["$email->usePlainText();", "$email->setMailType('text');", "$email->setMailType('plain');", "$email->setFormat('plain');"],
                correct: 1
            },
            {
                question: "Which method would you use to set the email sender's name?",
                options: ["$email->setSender('email', 'Name');", "$email->setSenderName('email', 'Name');", "$email->setFrom('email', 'Name');", "$email->from('email', 'Name');"],
                correct: 2
            },
            {
                question: "Which service is used to handle file uploads in CodeIgniter 4?",
                options: ["Validation", "Email", "Session", "Request"],
                correct: 3
            },
            {
                question: "Which method is used to open an image for manipulation?",
                options: ["openImage()", "withFile()", "getImage()", "loadImage()"],
                correct: 1
            },
            {
                question: "What method is used to resize an image in CodeIgniter 4?",
                options: ["scale()", "changeSize()", "alterSize()", "resize()"],
                correct: 3
            },
            {
                question: "Which method allows you to get the dimensions of an image?",
                options: ["imageSize()", "imageDimensions()", "getSize()", "getDimensions()"],
                correct: 3
            },
            {
                question: "How do you specify the quality of an image when saving it in CodeIgniter 4?",
                options: ["setQuality(85)", "quality(85)", "save('path', 85)", "setCompression(85)"],
                correct: 2
            },
            {
                question: "What is the default upload directory in CodeIgniter 4?",
                options: ["public/uploads/", "files/", "assets/uploads/", "writable/uploads/"],
                correct: 3
            },
            {
                question: "Which method is used to check the temporary file path of the uploaded file?",
                options: ["$file->getTemp();", "$file->getTempName();", "$file->tempPath();", "$file->tempName();"],
                correct: 1
            },
            {
                question: "Which service is used to handle image manipulation in CodeIgniter 4?",
                options: ["\\Config\\Services::image()", "\\Config\\Services::upload()", "\\Config\\Services::graphics()", "\\Config\\Services::manipulate()"],
                correct: 0
            },
            {
                question: "How do you add text to an image in CodeIgniter 4?",
                options: ["addText('Text')", "writeText('Text')", "text('Text')", "insertText('Text')"],
                correct: 2
            },
            {
                question: "How do you set the email format to HTML in CodeIgniter 4?",
                options: ["$email->setFormat('html');", "$email->setMailType('html');", "$email->useHTML();", "$email->formatAsHTML();"],
                correct: 1
            },
            {
                question: "How do you check if an email was successfully sent in CodeIgniter 4?",
                options: ["if ($email->isSent())", "if ($email->wasSent())", "if ($email->send())", "if ($email->sent())"],
                correct: 2
            },
            {
                question: "How do you move an uploaded file to a new location in CodeIgniter 4?",
                options: ["$file->moveTo('path');", "$file->uploadTo('path');", "$file->move('path');", "$file->relocate('path');"],
                correct: 2
            },
            {
                question: "What is the default driver used by CodeIgniter 4 for image manipulation?",
                options: ["Imagick", "GD", "ImageMagick", "GD2"],
                correct: 1
            },
            {
                question: "Which method is used to check if a file has been uploaded successfully?",
                options: ["is_uploaded()", "hasFile()", "isUploadedFile()", "isValid()"],
                correct: 3
            },
            {
                question: "Which method is used to get the size of an uploaded file?",
                // Correct answer confirmed: $file->getSize()
                options: ["$file->getSize();", "$file->size();", "$file->getSizeInBytes();", "$file->getFileSize();"],
                correct: 0
            },
            {
                question: "Which method would you use to blur an image in CodeIgniter 4?",
                options: ["blurImage()", "smudge()", "fuzzy()", "blur()"],
                correct: 3
            },
            {
                question: "How can you restrict the file types allowed for upload?",
                options: ["Using $file->filterTypes()", "Using $file->restrictTypes()", "Using $this->validate(['userfile' => 'uploaded[...]|mime_in[...]'])", "Using $file->setAllowedTypes()"],
                correct: 2
            },
            {
                question: "How do you retrieve the extension of an uploaded file?",
                options: ["$file->getExtension();", "$file->getExt();", "$file->getFileExtension();", "$file->extension();"],
                correct: 0
            },
            {
                question: "How do you rotate an image in CodeIgniter 4?",
                options: ["rotate()", "turn()", "flip()", "spin()"],
                correct: 0
            },
            {
                question: "How do you check for any errors that occurred during the file upload?",
                options: ["$file->getUploadError();", "$file->hasError();", "$file->checkError();", "$file->getError();"],
                correct: 3
            },
            {
                question: "What method can you use to get the original name of an uploaded file?",
                options: ["$file->getName();", "$file->getClientName();", "$file->fileName();", "$file->getOriginalName();"],
                correct: 1
            }
        ];

        // --- STATE ---
        let activeQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = new Array(rawQuestions.length).fill(null); // Stores index of selected option
        let userScores = new Array(rawQuestions.length).fill(null); // Stores 1 (correct) or 0 (incorrect)
        
        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const mapOverlay = document.getElementById('map-overlay');
        const mapGrid = document.getElementById('map-grid');
        
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const questionCounter = document.getElementById('question-counter');
        const currentScoreEl = document.getElementById('current-score');
        const progressBar = document.getElementById('progress-bar');
        const feedbackArea = document.getElementById('feedback-area');
        const feedbackText = document.getElementById('feedback-text');
        const correctAnswerText = document.getElementById('correct-answer-text');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');

        // --- LOGIC ---

        // Fisher-Yates Shuffle
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initQuiz() {
            // Deep copy and shuffle questions
            let tempQuestions = JSON.parse(JSON.stringify(rawQuestions));
            
            // Shuffle options within each question
            tempQuestions.forEach(q => {
                const correctOptionText = q.options[q.correct];
                q.options = shuffleArray(q.options);
                // Find new index of correct answer
                q.correct = q.options.indexOf(correctOptionText);
            });

            // Shuffle order of questions
            activeQuestions = shuffleArray(tempQuestions);

            // Reset State
            currentQuestionIndex = 0;
            userAnswers = new Array(activeQuestions.length).fill(null);
            userScores = new Array(activeQuestions.length).fill(null);

            // UI Transitions
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            loadQuestion();
        }

        function loadQuestion() {
            const currentQ = activeQuestions[currentQuestionIndex];
            
            // Update Text
            questionText.innerText = currentQ.question;
            questionCounter.innerText = `Question ${currentQuestionIndex + 1}/${activeQuestions.length}`;
            
            // Calculate Score
            const currentScore = userScores.filter(s => s === 1).length;
            currentScoreEl.innerText = `Score: ${currentScore}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / activeQuestions.length) * 100}%`;

            // Reset Options
            optionsContainer.innerHTML = '';
            feedbackArea.classList.add('hidden');
            
            // Disable/Enable Navigation
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.innerText = currentQuestionIndex === activeQuestions.length - 1 ? "Finish Review" : "Next ‚Üí";

            // Check if already answered
            const existingAnswer = userAnswers[currentQuestionIndex];
            const isAnswered = existingAnswer !== null;

            // Create Option Buttons
            currentQ.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-4 rounded-lg border-2 transition flex items-center group mb-2 relative overflow-hidden`;
                
                // Base styles
                if (!isAnswered) {
                    btn.className += ` border-gray-200 hover:bg-blue-50 hover:border-blue-300 cursor-pointer`;
                    btn.onclick = () => checkAnswer(index, btn);
                } else {
                    btn.className += ` cursor-default`;
                    // Apply persistent styles based on previous answer
                    if (index === currentQ.correct) {
                        btn.className += ` bg-green-100 border-green-500 text-green-900`;
                    } else if (index === existingAnswer) {
                        btn.className += ` bg-red-100 border-red-500 text-red-900`;
                    } else {
                        btn.className += ` border-gray-200 opacity-60`;
                    }
                }

                btn.innerHTML = `
                    <span class="w-8 h-8 flex items-center justify-center rounded-full font-bold mr-4 text-sm border 
                        ${isAnswered && index === currentQ.correct ? 'bg-green-200 text-green-800 border-green-300' : 
                          isAnswered && index === existingAnswer ? 'bg-red-200 text-red-800 border-red-300' : 
                          'bg-gray-100 text-gray-500 border-gray-200'}">
                        ${String.fromCharCode(65 + index)}
                    </span>
                    <span class="font-medium z-10">${opt}</span>
                `;
                
                optionsContainer.appendChild(btn);
            });

            // Show feedback if already answered
            if (isAnswered) {
                showFeedback(existingAnswer === currentQ.correct, currentQ);
            }
        }

        function checkAnswer(selectedIndex, selectedBtn) {
            const currentQ = activeQuestions[currentQuestionIndex];
            
            // Save State
            userAnswers[currentQuestionIndex] = selectedIndex;
            const isCorrect = selectedIndex === currentQ.correct;
            userScores[currentQuestionIndex] = isCorrect ? 1 : 0;

            // Reload to apply styles (easiest way to handle complex class logic)
            loadQuestion();
        }

        function showFeedback(isCorrect, currentQ) {
            feedbackArea.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'border-green-200', 'border-red-200');
            
            if (isCorrect) {
                feedbackArea.classList.add('bg-green-50', 'border-green-200');
                feedbackText.innerText = "Correct! üéâ";
                feedbackText.className = "font-bold mb-1 text-green-700";
                correctAnswerText.innerText = "";
            } else {
                feedbackArea.classList.add('bg-red-50', 'border-red-200');
                feedbackText.innerText = "Incorrect ‚ùå";
                feedbackText.className = "font-bold mb-1 text-red-700";
                correctAnswerText.innerText = `The correct answer was: ${currentQ.options[currentQ.correct]}`;
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < activeQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            toggleMap();
            loadQuestion();
        }

        function toggleMap() {
            const isHidden = mapOverlay.classList.contains('hidden');
            if (isHidden) {
                renderMap();
                mapOverlay.classList.remove('hidden');
            } else {
                mapOverlay.classList.add('hidden');
            }
        }

        function renderMap() {
            mapGrid.innerHTML = '';
            activeQuestions.forEach((_, index) => {
                const btn = document.createElement('button');
                const status = userScores[index]; // 1 = correct, 0 = wrong, null = unanswered
                
                let bgClass = 'bg-gray-100 text-gray-600 border-gray-300 hover:bg-blue-100'; // Default
                
                if (status === 1) bgClass = 'bg-green-500 text-white border-green-600 hover:bg-green-600 shadow-sm';
                else if (status === 0) bgClass = 'bg-red-500 text-white border-red-600 hover:bg-red-600 shadow-sm';
                
                if (index === currentQuestionIndex) {
                    bgClass += ' ring-2 ring-offset-1 ring-blue-500';
                }

                btn.className = `h-10 w-full rounded-md border font-bold text-sm transition ${bgClass}`;
                btn.innerText = index + 1;
                btn.onclick = () => jumpToQuestion(index);
                mapGrid.appendChild(btn);
            });
        }

        function finishQuiz() {
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            const totalScore = userScores.filter(s => s === 1).length;
            document.getElementById('final-score').innerText = `${totalScore} / ${activeQuestions.length}`;
        }
    </script>
</body>
</html>